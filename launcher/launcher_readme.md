# Лаунчер Gigabah (Пошаговое руководство)

Этот файл объясняет, что нужно заменить и как подготовить полное обновляемое окружение.

## 1. Структура
```
launcher/                <- проект лаунчера Godot
  project.godot
  scenes/Launcher.tscn
  scripts/
    launcher.gd
    update_manager.gd
  manifest_example.json  <- пример формата
  README_LAUNCHER.md     <- общая англ. дока
  launcher_readme.md     <- текущий файл (rus, практические шаги)
```
Корень репозитория после обновлений будет иметь папку `game/` (создаётся лаунчером при установке билда).

## 2. Что нужно ЗАМЕНИТЬ (минимально)
| Что | Где | На что заменить |
|-----|-----|------------------|
| `MANIFEST_URL` | `launcher/scripts/update_manager.gd` | HTTPS URL до вашего реального `manifest.json` |
| `package.url` | в реальном `manifest.json` | Ссылка на ZIP с полной сборкой |
| `package.sha256` | в реальном `manifest.json` | Фактический SHA-256 ZIP архива |
| `patches.*.url` | (опционально) в `manifest.json` | URL патч-архива (только изменённые файлы) |
| `patches.*.sha256` | (опционально) | SHA-256 патч-архива |
| `executable` | в `manifest.json` | Имя exe внутри ZIP (например `Godessa.exe`) |
| `game_version` | в `manifest.json` | Текущая версия (формат X.Y.Z) |

## 3. Подготовка первой ПОЛНОЙ сборки
1. Открой проект игры (НЕ лаунчер) в Godot → экспортируй Windows билд (например в `build_windows/`).
2. Убедись, что в корне экспортированных файлов присутствует файл с exe (например `Godessa.exe`).
3. Создай файл `version.json` рядом с exe:
   ```json
   { "game_version": "0.1.0" }
   ```
4. Упакуй всё содержимое папки (не добавляй лишнюю вложенную папку) в `gigabah_0.1.0.zip`.
5. Посчитай SHA-256:
   - Linux / Git Bash:
     ```bash
     sha256sum gigabah_0.1.0.zip
     ```
   - PowerShell:
     ```powershell
     Get-FileHash gigabah_0.1.0.zip -Algorithm SHA256
     ```
6. Создай `manifest.json` (можно скопировать `manifest_example.json`) и замени поля:
   ```json
   {
     "game_version": "0.1.0",
     "changelog_bbcode": "[b]0.1.0[/b]\n- Initial release",
     "package": {
       "url": "https://cdn.example.com/gigabah/builds/gigabah_0.1.0.zip",
       "size": 12345678,
       "sha256": "<ВСТАВЬ_ХЭШ_64hex>"
     },
     "executable": "Godessa.exe"
   }
   ```
7. Залей `gigabah_0.1.0.zip` и `manifest.json` на HTTPS хостинг (варианты ниже).
8. Обнови `MANIFEST_URL` в `update_manager.gd`.

## 4. Хостинг вариантов
- **GitHub Releases**: загрузить ZIP + manifest → получить прямые ссылки (может понадобиться raw через API или отдельный CDN).
- **S3 / R2 / MinIO**: настроить публичное чтение + HTTPS
- **Cloudflare Pages / Netlify**: статическая папка с файлами
- **Свой Nginx**: убедись что отдаются корректные `Content-Type` (ZIP → `application/zip`, JSON → `application/json`).

## 5. Проверка локально (быстрый сценарий)
1. Запусти лаунчер проект (`launcher/project.godot`).
2. Убедись, что без `game/` он показывает отсутствие локальной версии и скачивает.
3. После скачивания появится папка `game/` + `version.json`.
4. Кнопка запуска станет активной → запускает exe → лаунчер закрывается.

## 6. Подготовка ПАТЧА (дифф) к версии 0.1.0 → 0.1.1 (overlay метод)
1. Экспортируй новую версию в `build_new/`.
2. Сохрани старую папку (или выгрузи из архива) как `build_old/`.
3. Найди изменённые файлы (скрипты, ресурсы, бинары):
   - Можно использовать утилиты: `rsync`, `robocopy`, `diff`, либо IDE сравнение.
4. Скопируй изменённые/новые файлы в `patch_delta/` (та же структура путей, что и в полной сборке).
5. Упакуй содержимое `patch_delta/` → `patch_0.1.0_to_0.1.1.zip`.
6. Посчитай SHA-256 патча.
7. Обнови manifest (уже новый `game_version`):
   ```json
   {
     "game_version": "0.1.1",
     "changelog_bbcode": "[b]0.1.1[/b]\n- Fixes\n- Improvements",
     "package": { ... полный пакет 0.1.1 ... },
     "executable": "Godessa.exe",
     "patches": {
       "0.1.0": {
         "url": "https://cdn.example.com/gigabah/patch_0.1.0_to_0.1.1.zip",
         "size": 34567,
         "sha256": "<ХЭШ_ПАТЧА>"
       }
     }
   }
   ```
8. Залей патч ZIP и обновлённый manifest.
9. Клиенты с 0.1.0 получат сначала патч, остальные (или при ошибке) — полный пакет.

## 7. Удаление файлов при патче (ещё не реализовано)
Если нужно удалять старые файлы, сейчас есть варианты:
- Выпустить полный пакет (рекомендуется периодически).
- Добавить вручную поддержку списка удалений:
  ```json
  "patches": {
    "0.1.0": {
      "url": "...",
      "sha256": "...",
      "remove": ["old/path/file1", "obsolete/dir/file2"]
    }
  }
  ```
  И доработать `update_manager.gd`: после распаковки патча пройтись по массиву и удалить.

## 8. Настройка версии
Файл `game/version.json` пишется лаунчером автоматически после установки. Не нужно редактировать вручную на клиенте.

## 9. Авто-закрытие
Если хотите чтобы лаунчер НЕ закрывался после запуска игры — удалите строку `get_tree().quit()` в `launcher/scripts/launcher.gd`.

## 10. Диагностика проблем
| Симптом | Возможная причина | Что сделать |
|---------|------------------|------------|
| Вечный статус "Загрузка манифеста" | Неверный URL / блокировка сети | Проверь HTTPS, открой ссылку в браузере |
| Пустой прогресс при скачивании | Сервер не отдал `Content-Length` | Это нормально, если размер неизвестен |
| Ошибка хэша | Неправильный SHA-256 в manifest | Пересчитай и обнови manifest |
| Патч не применился → скачался полный пакет | Структура патча неправильная | Проверь относительные пути / содержимое ZIP |

## 11. Рекомендуемый цикл релиза
1. Экспорт → полный ZIP.
2. Генерация SHA-256.
3. (Опционально) Патч против предыдущей версии.
4. Публикация файлов.
5. Обновление `manifest.json`.
6. Smoke-тест лаунчером.
7. Анонс пользователям.

## 12. Минимальная безопасность
- Всегда HTTPS.
- Не меняйте содержимое уже опубликованного ZIP (иначе хэш не совпадёт).
- Можно дополнительно размещать manifest с `Cache-Control: no-cache`.
- Возможное расширение: цифровая подпись manifest и ZIP.

## 13. Быстрый чеклист перед выкладкой
- [ ] MANIFEST_URL указывает на прод ресурс
- [ ] manifest.json открывается в браузере
- [ ] Полный пакет скачивается и распаковывается вручную корректно
- [ ] SHA-256 проверен
- [ ] Патч (если есть) протестирован локально (разница файлов адекватна)
- [ ] Лаунчер показал новую версию и применил обновление
- [ ] Запуск exe работает

## 14. Что можно улучшить позже
- Удаления файлов при патчах
- Множественные каналы (beta / stable)
- Подписи и проверка GPG / RSA
- Инкрементальная загрузка (range / resume)
- Хранение лога обновлений локально (`launcher.log`)

---
Если нужно — могу сразу внедрить поддержку удаления файлов или подписей. Напиши следующую задачу.
